{% extends "base.html" %}

{% block title %}рдЙрдкрдЧреНрд░рд╣ рдирд┐рдЧрд░рд╛рдиреА - Krishi Sahayak{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-success mb-1">ЁЯЫ░я╕П рдЙрдкрдЧреНрд░рд╣ рдлрд╕рд▓ рдирд┐рдЧрд░рд╛рдиреА</h2>
            <p class="text-muted mb-0">NASA рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛ рд╕реЗ рдлрд╕рд▓ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╡рд┐рд╢реНрд▓реЗрд╖рдг</p>
        </div>
    </div>

    <div class="row">
        <!-- Location Input -->
        <div class="col-lg-4 col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title text-success mb-3">ЁЯУН рдЦреЗрдд рдХрд╛ рд╕реНрдерд╛рди</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">рдЕрдХреНрд╖рд╛рдВрд╢ (Latitude)</label>
                        <input type="number" class="form-control" id="latitude" step="0.000001" placeholder="рдЬреИрд╕реЗ: 28.6139">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">рджреЗрд╢рд╛рдВрддрд░ (Longitude)</label>
                        <input type="number" class="form-control" id="longitude" step="0.000001" placeholder="рдЬреИрд╕реЗ: 77.2090">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">рдЦреЗрдд рдХрд╛ рдХреНрд╖реЗрддреНрд░рдлрд▓ (рдХрд┐рдореА┬▓)</label>
                        <input type="number" class="form-control" id="farm_area" step="0.1" min="0.1" value="1" placeholder="1">
                    </div>
                    
                    <button class="btn btn-success w-100" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow"></i> рд╡рд░реНрддрдорд╛рди рд╕реНрдерд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
                    </button>
                    
                    <button class="btn btn-primary w-100 mt-2" onclick="getSatelliteData()">
                        <i class="fas fa-satellite"></i> рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="col-lg-8 col-12">
            <div id="loadingDiv" class="card border-0 shadow-sm d-none">
                <div class="card-body text-center p-4">
                    <div class="spinner-border text-success mb-3"></div>
                    <h5>рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ...</h5>
                    <p class="text-muted">рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ</p>
                </div>
            </div>

            <div id="resultsDiv" class="d-none">
                <!-- Satellite Images -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <h5 class="card-title text-primary">ЁЯЫ░я╕П рдЙрдкрдЧреНрд░рд╣ рдЪрд┐рддреНрд░</h5>
                        <div class="row" id="satelliteImages">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Health Analysis -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <h5 class="card-title text-success">ЁЯМ▒ рдлрд╕рд▓ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╡рд┐рд╢реНрд▓реЗрд╖рдг</h5>
                        <div id="healthAnalysis">
                            <!-- Analysis will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h5 class="card-title text-info">ЁЯТб рд╕реБрдЭрд╛рд╡</h5>
                        <div id="recommendations">
                            <!-- Recommendations will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
            document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
        }, function(error) {
            alert('рд╕реНрдерд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ' + error.message);
        });
    } else {
        alert('рдЖрдкрдХрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдЬрд┐рдпреЛрд▓реЛрдХреЗрд╢рди рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддрд╛');
    }
}

function getSatelliteData() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lon = parseFloat(document.getElementById('longitude').value);
    const farmArea = parseFloat(document.getElementById('farm_area').value);
    
    if (!lat || !lon) {
        alert('рдХреГрдкрдпрд╛ рдЕрдХреНрд╖рд╛рдВрд╢ рдФрд░ рджреЗрд╢рд╛рдВрддрд░ рджрд░реНрдЬ рдХрд░реЗрдВ');
        return;
    }
    
    // Show loading
    document.getElementById('loadingDiv').classList.remove('d-none');
    document.getElementById('resultsDiv').classList.add('d-none');
    
    // Send request
    fetch('/api/satellite-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lat: lat,
            lon: lon,
            farm_area: farmArea
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingDiv').classList.add('d-none');
        
        if (data.success) {
            displaySatelliteResults(data);
        } else {
            alert('рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ' + data.error);
            if (data.fallback_data) {
                displaySatelliteResults(data.fallback_data);
            }
        }
    })
    .catch(error => {
        document.getElementById('loadingDiv').classList.add('d-none');
        console.error('Error:', error);
        alert('рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ рд╣реБрдИ');
    });
}

function displaySatelliteResults(data) {
    // Display satellite images
    let imagesHtml = '';
    if (data.vegetation_image) {
        imagesHtml += `
            <div class="col-md-6 mb-3">
                <div class="text-center">
                    <h6>ЁЯМ▒ рд╡рдирд╕реНрдкрддрд┐ рд╕реВрдЪрдХрд╛рдВрдХ</h6>
                    <img src="data:image/png;base64,${data.vegetation_image}" class="img-fluid rounded border" alt="Vegetation Index" style="max-height: 200px;">
                    <small class="text-success d-block mt-1">тЬЕ NASA рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛</small>
                </div>
            </div>
        `;
    }
    if (data.true_color_image) {
        imagesHtml += `
            <div class="col-md-6 mb-3">
                <div class="text-center">
                    <h6>ЁЯЫ░я╕П рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд░рдВрдЧ рдЪрд┐рддреНрд░</h6>
                    <img src="data:image/jpeg;base64,${data.true_color_image}" class="img-fluid rounded border" alt="True Color" style="max-height: 200px;">
                    <small class="text-success d-block mt-1">тЬЕ NASA рдЙрдкрдЧреНрд░рд╣ рдбреЗрдЯрд╛</small>
                </div>
            </div>
        `;
    }
    if (!imagesHtml) {
        imagesHtml = '<div class="col-12"><p class="text-muted">рдЙрдкрдЧреНрд░рд╣ рдЪрд┐рддреНрд░ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИрдВ</p></div>';
    }
    document.getElementById('satelliteImages').innerHTML = imagesHtml;
    
    // Display health analysis
    const analysis = data.health_analysis;
    const healthHtml = `
        <div class="row">
            <div class="col-md-4 text-center">
                <div class="bg-light p-3 rounded">
                    <h3 class="text-success">${analysis.health_score}%</h3>
                    <small>рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реНрдХреЛрд░</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="bg-light p-3 rounded">
                    <h5 class="text-primary">${analysis.vegetation_density}</h5>
                    <small>рд╡рдирд╕реНрдкрддрд┐ рдШрдирддреНрд╡</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="bg-light p-3 rounded">
                    <h6 class="text-info">${analysis.growth_stage}</h6>
                    <small>рд╡реГрджреНрдзрд┐ рдЕрд╡рд╕реНрдерд╛</small>
                </div>
            </div>
        </div>
        ${analysis.alerts && analysis.alerts.length > 0 ? `
            <div class="mt-3">
                <h6>рдЪреЗрддрд╛рд╡рдиреА:</h6>
                ${analysis.alerts.map(alert => `<div class="alert ${alert.includes('тЬЕ') ? 'alert-success' : 'alert-warning'} py-2">${alert}</div>`).join('')}
            </div>
        ` : ''}
        ${analysis.data_source ? `
            <div class="mt-3">
                <small class="badge ${analysis.data_source === 'NASA GIBS Satellite' ? 'bg-success' : 'bg-warning'}">
                    ЁЯУК рдбреЗрдЯрд╛ рд╕реНрд░реЛрдд: ${analysis.data_source}
                </small>
            </div>
        ` : ''}
    `;
    document.getElementById('healthAnalysis').innerHTML = healthHtml;
    
    // Display recommendations
    const recommendationsHtml = `
        <ul class="list-unstyled">
            ${analysis.recommendations.map(rec => `<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>${rec}</li>`).join('')}
        </ul>
        <div class="mt-3">
            <small class="text-muted">рдбреЗрдЯрд╛ рддрд┐рдерд┐: ${data.date || 'рдЕрдЬреНрдЮрд╛рдд'}</small>
        </div>
    `;
    document.getElementById('recommendations').innerHTML = recommendationsHtml;
    
    // Show results
    document.getElementById('resultsDiv').classList.remove('d-none');
}
</script>
{% endblock %}