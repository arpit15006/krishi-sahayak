{% extends "base.html" %}

{% block title %}{{ post.title }} - ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <!-- Back Button -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('community') }}" class="btn btn-outline-success btn-sm">
                <i class="fas fa-arrow-left"></i> ‡§µ‡§æ‡§™‡§∏ ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç
            </a>
        </div>
    </div>

    <!-- Main Post -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- Post Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            {% if post.is_ai %}
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                ü§ñ
                            </div>
                            {% else %}
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                üë®üåæ
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-0">{{ post.farmer_name }}</h5>
                                <small class="text-muted">{{ post.farmer_place }}</small>
                                <br>
                                <small class="text-muted">{{ post.created_at|time_ago }}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            {% if post.is_question %}
                            <span class="badge bg-warning text-dark mb-1">‚ùì ‡§∏‡§µ‡§æ‡§≤</span>
                            {% else %}
                            <span class="badge bg-info mb-1">üí° ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</span>
                            {% endif %}
                            <br>
                            {% if post.is_solved %}
                            <span class="badge bg-success">‚úÖ ‡§π‡§≤ ‡§π‡•ã ‡§ó‡§Ø‡§æ</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Post Content -->
                    <h3 class="card-title mb-3">{{ post.title }}</h3>
                    <div class="card-text mb-4" style="white-space: pre-wrap;">{{ post.content }}</div>

                    <!-- Post Actions -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3">
                            <button class="btn btn-outline-success" onclick="votePost('{{ post.id }}', 'upvote')">
                                üëç <span id="upvotes">{{ post.upvotes or 0 }}</span>
                            </button>
                            <button class="btn btn-outline-danger" onclick="votePost('{{ post.id }}', 'downvote')">
                                üëé <span id="downvotes">{{ post.downvotes or 0 }}</span>
                            </button>
                        </div>
                        <span class="badge bg-secondary">{{ post.category }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <h5 class="card-title mb-3">üí¨ ‡§Ö‡§™‡§®‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç</h5>
                    <form id="replyForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="replyContent" rows="4" placeholder="‡§Ö‡§™‡§®‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> ‡§ú‡§µ‡§æ‡§¨ ‡§≠‡•á‡§ú‡•á‡§Ç
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Replies -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">üí¨ ‡§ú‡§µ‡§æ‡§¨ ({{ replies|length }})</h4>
            
            <div id="repliesContainer">
                {% if replies %}
                    {% for reply in replies %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <!-- Reply Header -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    {% if reply.is_ai %}
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                        ü§ñ
                                    </div>
                                    {% else %}
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                        üë®üåæ
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ reply.farmer_name }}</h6>
                                        <small class="text-muted">{{ reply.farmer_place }}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    {% if reply.is_ai %}
                                    <span class="badge bg-primary">ü§ñ AI ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞</span>
                                    {% endif %}
                                    {% if reply.is_best_answer %}
                                    <span class="badge bg-success">‚úÖ ‡§¨‡•á‡§∏‡•ç‡§ü ‡§ú‡§µ‡§æ‡§¨</span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Reply Content -->
                            <div class="mb-3" style="white-space: pre-wrap;">{{ reply.content }}</div>

                            <!-- Reply Actions -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="voteReply('{{ reply.id }}', 'upvote')">
                                        üëç {{ reply.upvotes or 0 }}
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="voteReply('{{ reply.id }}', 'downvote')">
                                        üëé {{ reply.downvotes or 0 }}
                                    </button>
                                </div>
                                <small class="text-muted">
                                    {{ reply.created_at|time_ago }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-comment fa-2x text-muted"></i>
                        </div>
                        <h5 class="text-muted">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç</h5>
                        <p class="text-muted">‡§™‡§π‡§≤‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§¨‡§®‡•á‡§Ç!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Handle reply form submission
document.getElementById('replyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = document.getElementById('replyContent').value.trim();
    if (!content) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§≤‡§ø‡§ñ‡•á‡§Ç');
        return;
    }
    
    fetch('/api/community/reply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            post_id: '{{ post.id }}',
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear form
            document.getElementById('replyContent').value = '';
            // Reload page to show new reply
            location.reload();
        } else {
            alert('‡§ú‡§µ‡§æ‡§¨ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Reply error:', error);
        alert('‡§ú‡§µ‡§æ‡§¨ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à');
    });
});

function votePost(postId, voteType) {
    fetch('/api/community/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            post_id: postId,
            vote_type: voteType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show updated votes
        } else {
            alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Vote error:', error);
        alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à');
    });
}

function voteReply(replyId, voteType) {
    fetch('/api/community/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reply_id: replyId,
            vote_type: voteType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show updated votes
        } else {
            alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Vote error:', error);
        alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à');
    });
}
</script>
{% endblock %}