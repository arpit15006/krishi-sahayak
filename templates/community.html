{% extends "base.html" %}

{% block title %}‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø - Krishi Sahayak{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-success mb-1">üí¨ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø</h2>
                    <p class="text-muted mb-0">‡§Ö‡§™‡§®‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</p>
                </div>
                <a href="{{ url_for('new_community_post') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> ‡§®‡§Ø‡§æ ‡§∏‡§µ‡§æ‡§≤
                </a>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="‡§∏‡§µ‡§æ‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
                        <button class="btn btn-outline-success" type="button" onclick="searchPosts()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('community', category='all') }}" 
                   class="btn btn-sm {{ 'btn-success' if current_category == 'all' else 'btn-outline-success' }}">
                    ‡§∏‡§≠‡•Ä
                </a>
                {% for category in categories %}
                <a href="{{ url_for('community', category=category.name) }}" 
                   class="btn btn-sm {{ 'btn-success' if current_category == category.name else 'btn-outline-success' }}">
                    {{ category.icon }} {{ category.description }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Posts List -->
    <div class="row" id="postsContainer">
        {% if posts %}
            {% for post in posts %}
            <div class="col-12 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <!-- Post Header -->
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                {% if post.is_ai %}
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                    ü§ñ
                                </div>
                                {% else %}
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                    üë®‚Äçüåæ
                                </div>
                                {% endif %}
                                <div>
                                    <h6 class="mb-0">{{ post.farmer_name }}</h6>
                                    <small class="text-muted">{{ post.farmer_place }}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                {% if post.is_question %}
                                <span class="badge bg-warning text-dark">‚ùì ‡§∏‡§µ‡§æ‡§≤</span>
                                {% else %}
                                <span class="badge bg-info">üí° ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</span>
                                {% endif %}
                                {% if post.is_solved %}
                                <span class="badge bg-success">‚úÖ ‡§π‡§≤ ‡§π‡•ã ‡§ó‡§Ø‡§æ</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Post Content -->
                        <a href="{{ url_for('community_post', post_id=post.id) }}" class="text-decoration-none text-dark">
                            <h5 class="card-title mb-2">{{ post.title }}</h5>
                            <p class="card-text text-muted">{{ post.content[:150] }}{% if post.content|length > 150 %}...{% endif %}</p>
                        </a>

                        <!-- Post Footer -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex gap-3">
                                <button class="btn btn-sm btn-outline-success" onclick="votePost('{{ post.id }}', 'upvote')">
                                    üëç {{ post.upvotes or 0 }}
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="votePost('{{ post.id }}', 'downvote')">
                                    üëé {{ post.downvotes or 0 }}
                                </button>
                                <span class="text-muted">
                                    {% for category in categories %}
                                        {% if category.name == post.category %}
                                            {{ category.icon }} {{ category.description }}
                                        {% endif %}
                                    {% endfor %}
                                </span>
                            </div>
                            <small class="text-muted">
                                {{ post.created_at|time_ago }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-comments fa-3x text-muted"></i>
                    </div>
                    <h4 class="text-muted">‡§ï‡•ã‡§à ‡§∏‡§µ‡§æ‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</h4>
                    <p class="text-muted">‡§™‡§π‡§≤‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§¨‡§®‡•á‡§Ç!</p>
                    <a href="{{ url_for('new_community_post') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> ‡§®‡§Ø‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function searchPosts() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;
    
    fetch(`/api/community/search?q=${encodeURIComponent(query)}&category={{ current_category }}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.posts);
            } else {
                alert('‡§ñ‡•ã‡§ú ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('‡§ñ‡•ã‡§ú ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à');
        });
}

function displaySearchResults(posts) {
    const container = document.getElementById('postsContainer');
    if (posts.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <h4 class="text-muted">‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</h4>
                    <p class="text-muted">‡§ï‡•Å‡§õ ‡§î‡§∞ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç</p>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = posts.map(post => `
        <div class="col-12 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <div class="bg-${post.is_ai ? 'primary' : 'success'} text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                ${post.is_ai ? 'ü§ñ' : 'üë®‚Äçüåæ'}
                            </div>
                            <div>
                                <h6 class="mb-0">${post.farmer_name}</h6>
                                <small class="text-muted">${post.farmer_place}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${post.is_question ? 'warning' : 'info'} text-dark">
                                ${post.is_question ? '‚ùì ‡§∏‡§µ‡§æ‡§≤' : 'üí° ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä'}
                            </span>
                        </div>
                    </div>
                    <a href="/community/post/${post.id}" class="text-decoration-none text-dark">
                        <h5 class="card-title mb-2">${post.title}</h5>
                        <p class="card-text text-muted">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</p>
                    </a>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex gap-3">
                            <button class="btn btn-sm btn-outline-success" onclick="votePost('${post.id}', 'upvote')">
                                üëç ${post.upvotes || 0}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="votePost('${post.id}', 'downvote')">
                                üëé ${post.downvotes || 0}
                            </button>
                        </div>
                        <small class="text-muted">‡§Ö‡§≠‡•Ä</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function votePost(postId, voteType) {
    fetch('/api/community/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            post_id: postId,
            vote_type: voteType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show updated votes
        } else {
            alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Vote error:', error);
        alert('‡§µ‡•ã‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à');
    });
}

// Search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPosts();
    }
});
</script>
{% endblock %}