"""
Simple deployment script for MONAD testnet
"""

import json
import os
from web3 import Web3
from eth_account import Account
from dotenv import load_dotenv

# Load environment variables
load_dotenv('../.env')

def deploy_simple_contract():
    """Deploy pre-compiled contract bytecode"""
    
    # Connect to MONAD
    rpc_url = "https://testnet-rpc.monad.xyz"
    w3 = Web3(Web3.HTTPProvider(rpc_url))
    
    if not w3.is_connected():
        print("‚ùå Failed to connect to MONAD Testnet")
        return None
    
    print("‚úÖ Connected to MONAD Testnet")
    
    # Load account
    private_key = os.getenv('MONAD_PRIVATE_KEY')
    if not private_key:
        print("‚ùå MONAD_PRIVATE_KEY not found")
        return None
    
    # Remove quotes if present
    private_key = private_key.strip('"')
    
    account = Account.from_key(private_key)
    print(f"üìù Deploying from: {account.address}")
    
    # Check balance
    balance = w3.eth.get_balance(account.address)
    balance_eth = w3.from_wei(balance, 'ether')
    print(f"üí∞ Balance: {balance_eth} MON")
    
    if balance_eth < 0.01:
        print("‚ùå Insufficient balance for deployment")
        return None
    
    # Simple contract bytecode (pre-compiled SimpleCropPassport)
    # This is a minimal version for testing
    bytecode = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506108b8806100606000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c80638da5cb5b1161005b5780638da5cb5b146101285780639b19251a14610146578063a22cb46514610176578063e985e9c51461019257610088565b8063081812fc1461008d57806318160ddd146100bd57806323b872dd146100db5780636352211e146100f7575b600080fd5b6100a760048036038101906100a29190610567565b6101c2565b6040516100b491906105d5565b60405180910390f35b6100c5610208565b6040516100d29190610609565b60405180910390f35b6100f560048036038101906100f09190610624565b610212565b005b610111600480360381019061010c9190610567565b610272565b60405161011f9291906106b6565b60405180910390f35b6101306102c4565b60405161013d91906105d5565b60405180910390f35b610160600480360381019061015b91906106df565b6102ea565b60405161016d919061071b565b60405180910390f35b610190600480360381019061018b9190610762565b61033e565b005b6101ac60048036038101906101a791906107a2565b610344565b6040516101b991906107ed565b60405180910390f35b60006001600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6000600254905090565b61021b81610272565b73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161461025257600080fd5b61025c8382610378565b61026d61026882610272565b610378565b505050565b60008060008381526020019081526020016000206040518060400160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815250509050806000015191508091505092915050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b606060036000838152602001908152602001600020805480602002602001604051908101604052809291908181526020018280548015610332576020028201919060005260206000209081548152602001906001019080831161031e575b50505050509050919050565b50505050565b6000600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036103e7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103de90610854565b60405180910390fd5b6000818152602001908152602001600020600001600090815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614610499576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610490906108c0565b60405180910390fd5b50565b600080fd5b6000819050919050565b6104b4816104a1565b81146104bf57600080fd5b50565b6000813590506104d1816104ab565b92915050565b6000602082840312156104ed576104ec61049c565b5b60006104fb848285016104c2565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061052f82610504565b9050919050565b61053f81610524565b82525050565b600061055082610504565b9050919050565b61056081610545565b82525050565b60006020828403121561057c5761057b61049c565b5b600061058a848285016104c2565b91505092915050565b61059c81610524565b82525050565b6000819050919050565b6105b5816105a2565b82525050565b6000604082019050610593600083018561059c565b6105ac60208301846105ac565b9392505050565b6105dc816104a1565b82525050565b60006020820190506105f760008301846105d3565b92915050565b61060681610524565b82525050565b600060208201905061062160008301846105fd565b92915050565b60006060828403121561063d5761063c61049c565b5b600061064b848285016104c2565b915050600061065c848285016104c2565b915050600061066d848285016104c2565b9150509250925092565b600061068282610504565b9050919050565b61069281610677565b82525050565b6000819050919050565b6106ab81610698565b82525050565b60006040820190506106c66000830185610689565b6106d360208301846106a2565b9392505050565b6000602082840312156106f0576106ef61049c565b5b60006106fe84828501610677565b91505092915050565b600081519050919050565b61071b81610707565b82525050565b60006020820190506107366000830184610712565b92915050565b60008115159050919050565b6107518161073c565b811461075c57600080fd5b50565b60008135905061076e81610748565b92915050565b6000604082840312156107885761078761049c565b5b6000610796848285016104c2565b91505060206107a78482850161075f565b91505092915050565b600080604083850312156107c7576107c661049c565b5b60006107d585828601610677565b92505060206107e685828601610677565b9150509250929050565b600060208201905061080560008301846107ed565b92915050565b7f4552433732313a20617070726f76616c20746f2063757272656e74206f776e6560008201527f7200000000000000000000000000000000000000000000000000000000000000602082015250565b6000610867602183610707565b91506108728261080b565b604082019050919050565b600060208201905081810360008301526108968161085a565b9050919050565b7f4552433732313a20617070726f76652063616c6c6572206973206e6f74206f7760008201527f6e6572206e6f7220617070726f76656420666f7220616c6c0000000000000000602082015250565b60006108f9603883610707565b91506109048261089d565b604082019050919050565b60006020820190508181036000830152610928816108ec565b905091905056fea2646970667358221220f8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c864736f6c63430008130033"
    
    # Build deployment transaction
    transaction = {
        'from': account.address,
        'data': bytecode,
        'gas': 800000,
        'gasPrice': 100000000000,  # 100 gwei
        'nonce': w3.eth.get_transaction_count(account.address),
        'chainId': 10143
    }
    
    print("üì§ Deploying contract...")
    
    # Sign and send transaction
    signed_txn = w3.eth.account.sign_transaction(transaction, private_key)
    tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)
    
    print(f"‚è≥ Transaction hash: {tx_hash.hex()}")
    print("‚è≥ Waiting for confirmation...")
    
    # Wait for deployment
    receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    
    if receipt.status == 1:
        contract_address = receipt.contractAddress
        print(f"‚úÖ Contract deployed successfully!")
        print(f"üìç Contract address: {contract_address}")
        print(f"üîó Explorer: https://testnet-explorer.monad.xyz/address/{contract_address}")
        
        # Update config file
        config_update = f"""
# Update your .env file with:
CONTRACT_ADDRESS={contract_address}
"""
        print(config_update)
        
        return contract_address
    else:
        print("‚ùå Deployment failed")
        return None

if __name__ == "__main__":
    print("üöÄ Simple MONAD Deployment")
    print("=" * 40)
    
    contract_address = deploy_simple_contract()
    
    if contract_address:
        print("\nüéâ Deployment completed!")
        print(f"Contract: {contract_address}")
        print("\nNext: Update CONTRACT_ADDRESS in monad_config.py")
    else:
        print("\n‚ùå Deployment failed!")